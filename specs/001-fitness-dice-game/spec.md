# Feature Specification: 健身骰子遊戲 (Fitness Dice Game)

**Feature Branch**: `001-fitness-dice-game`  
**Created**: 2025-12-19  
**Status**: Draft  
**Input**: User description: "開發一個健身遊戲「弱雞轉換器」，玩家透過攝像頭執行跳躍+舉手動作來擲一個特殊骰子。骰子會隨機指派健身任務（例如：深蹲 15 次 x 2 組）。系統使用 YOLOv8-Pose 姿態識別來驗證玩家是否正確完成任務。遊戲包含以下狀態：等待開始、擲骰子動作檢測、任務展示、任務執行中、完成驗證。介面使用 PyGame 實作，需顯示即時攝像頭畫面、當前任務、進度條、骨架標記。骰子任務庫包含 10+ 種健身動作（深蹲、伏地挺身、開合跳等），每次隨機抽取並設定次數和組數。"

## Clarifications

### Session 2025-12-19

- Q: 動作驗證的容忍度閾值應設為多少（角度和距離誤差範圍）？ → A: 寬鬆模式（±15-20 度角度容忍，±10% 距離容忍）
- Q: 應選擇 YOLOv8n-pose 還是 YOLOv8s-pose 進行 TensorRT 優化？ → A: YOLOv8n-pose (nano) - 最快速度，~3M 參數，目標 30-40 FPS
- Q: PyGame 介面的畫面布局應如何設計（攝像頭、任務資訊、進度條的位置）？ → A: 左側攝像頭（70%）+ 右側資訊面板（30%），垂直分割布局
- Q: 擲骰子的「跳躍+舉手」動作是同時執行還是順序執行？ → A: 順序執行（先檢測跳躍，然後在 2 秒內檢測到舉手即觸發）
- Q: 任務庫配置檔案應使用 JSON 還是 YAML 格式？ → A: JSON - Python 原生支援，無需額外依賴

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 擲骰子獲取健身任務 (Priority: P1)

玩家站在攝像頭前，執行「跳躍+舉手」的動作來啟動骰子擲取機制。系統檢測到正確的動作組合後，隨機從任務庫中抽取一個健身任務（例如：深蹲 15 次 x 2 組），並在螢幕上清晰展示任務內容。

**Why this priority**: 這是遊戲的核心互動機制，沒有這個功能就無法開始任何遊戲流程。玩家必須先獲得任務才能進行後續的健身活動。

**Independent Test**: 可以透過站在攝像頭前執行跳躍+舉手動作，系統應在 2 秒內識別動作並顯示隨機任務，無需依賴任務執行功能即可驗證。

**Acceptance Scenarios**:

1. **Given** 遊戲處於「等待開始」狀態且攝像頭正常運作，**When** 玩家執行完整的「跳躍+舉手」動作，**Then** 系統在 2 秒內識別動作並轉換到「任務展示」狀態，顯示隨機抽取的健身任務
2. **Given** 玩家已在攝像頭前，**When** 玩家只執行跳躍但未舉手（或反之），**Then** 系統不應觸發骰子擲取，保持在「等待開始」或「擲骰子動作檢測」狀態
3. **Given** 系統已顯示一個任務，**When** 玩家完成或取消當前任務後再次執行擲骰子動作，**Then** 系統抽取並顯示新的隨機任務（可能與前一次相同或不同）
4. **Given** 任務庫包含 10+ 種不同的健身動作，**When** 玩家多次擲骰子，**Then** 系統應隨機分配不同的動作類型和數量組合

---

### User Story 2 - 即時姿態檢測與任務進度追蹤 (Priority: P2)

當玩家開始執行獲得的健身任務時，系統透過 YOLOv8-Pose 即時分析玩家的肢體動作，驗證動作是否正確執行（例如深蹲時膝蓋彎曲角度、伏地挺身時手臂位置）。每次正確完成一個動作，系統自動計數並更新進度條，顯示當前完成的次數和剩餘的組數。

**Why this priority**: 這是遊戲的驗證核心，確保玩家確實完成任務而非作弊。有了 P1 的任務分配，加上這個驗證機制，遊戲就具備完整的互動循環。

**Independent Test**: 可以先手動觸發一個特定任務（例如深蹲 5 次），然後在攝像頭前執行動作，系統應實時識別並計數，無需完整的遊戲流程。

**Acceptance Scenarios**:

1. **Given** 玩家獲得「深蹲 10 次 x 2 組」的任務且進入「任務執行中」狀態，**When** 玩家正確執行一次深蹲（膝蓋彎曲超過 90 度且起立），**Then** 系統計數增加 1 並更新螢幕顯示（例如：1/10 完成）
2. **Given** 玩家正在執行任務，**When** 玩家的動作不正確或不完整（例如深蹲未蹲到位），**Then** 系統不應增加計數，可選顯示提示訊息「動作不正確」
3. **Given** 玩家完成第一組的所有次數（例如 10/10），**When** 最後一次動作被正確識別，**Then** 系統顯示「第 1 組完成！準備開始第 2 組」並重置當前組的計數器
4. **Given** 玩家在執行任務，**When** 玩家暫時離開攝像頭視野超過 3 秒，**Then** 系統暫停計數並顯示「等待玩家回到畫面」提示
5. **Given** 螢幕顯示即時攝像頭畫面，**When** 系統偵測到骨架關鍵點，**Then** 畫面上應疊加骨架標記（關節點和連線）以幫助玩家調整姿勢

---

### User Story 3 - [Brief Title] (Priority: P3)

[Describe this user journey in plain language]

**Why this priority**: [Explain the value and why it has this priority level]
### User Story 3 - 完成驗證與遊戲循環 (Priority: P3)

當玩家完成所有組數和次數的健身任務後，系統進入「完成驗證」狀態，顯示慶祝動畫或訊息（例如「任務完成！你已不再是弱雞！」），並自動返回「等待開始」狀態，允許玩家再次擲骰子獲取新任務，形成連續的遊戲循環。

**Why this priority**: 這提供了遊戲的閉環體驗和正向回饋，但在前兩個功能完成前，可以手動重置來測試核心功能。優先級較低因為可以暫時用簡單的狀態重置代替。

**Independent Test**: 可以手動將系統設置為「任務執行中」狀態且計數器接近完成（例如 10/10，組數 2/2），然後執行最後一次動作，驗證完成訊息和狀態轉換。

**Acceptance Scenarios**:

1. **Given** 玩家正在執行最後一組的最後一次動作（例如第 2 組的第 10 次），**When** 系統識別到這次動作正確完成，**Then** 系統轉換到「完成驗證」狀態並顯示慶祝訊息持續 3-5 秒
2. **Given** 系統顯示完成訊息，**When** 慶祝訊息顯示時間結束，**Then** 系統自動返回「等待開始」狀態，清除之前的任務資訊，準備接受新的擲骰子動作
3. **Given** 玩家完成一個任務循環，**When** 玩家再次執行擲骰子動作，**Then** 系統應如同首次使用般流暢地進入新的任務循環（無殘留狀態）

---

### Edge Cases

- **攝像頭異常**：攝像頭斷線、無法取得畫面、FPS 低於 10 時，系統應顯示錯誤訊息「攝像頭故障，請檢查連接」並暫停遊戲
- **多人入鏡**：當畫面中出現多個人體骨架時，系統應追蹤畫面中最接近中心或最大的骨架，或顯示提示「請保持單人遊戲」
- **光線不足**：在低光環境下 YOLOv8-Pose 可能無法偵測骨架，系統應顯示「光線不足，請改善照明」
- **極端動作**：玩家執行過於劇烈或超出攝像頭視野的動作（例如跳太高導致頭部出框），系統應在動作不完整時不予計數
- **長時間無動作**：玩家在「任務執行中」狀態下超過 60 秒無有效動作，系統可選顯示「是否繼續任務？」並提供放棄選項
- **任務庫為空**：如果任務庫配置錯誤或文件損壞導致無可用任務，系統應顯示錯誤訊息並防止遊戲啟動
- **骨架遮擋**：當關鍵關節點（例如膝蓋、手腕）被遮擋或無法偵測時，系統應容忍短暫遮擋（<1 秒），但超過閾值時不計數該次動作
- **姿態識別延遲**：如果 TensorRT 推理時間超過 100ms，可能導致計數延遲，系統應維持 >20 FPS 的流暢度並在性能下降時提示

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須支援即時攝像頭捕獲，維持至少 20 FPS 的幀率，解析度為 1280x720 或 640x480（可配置）
- **FR-002**: 系統必須使用 YOLOv8-Pose 模型（TensorRT 加速）進行即時人體姿態偵測，推理延遲低於 50ms
- **FR-003**: 系統必須實作五個遊戲狀態的狀態機：「等待開始」、「擲骰子動作檢測」、「任務展示」、「任務執行中」、「完成驗證」
- **FR-004**: 系統必須在「擲骰子動作檢測」狀態下識別「跳躍+舉手」的複合動作，採用順序執行模式：先檢測到跳躍（雙腳離地且身體上升），然後在 2 秒時間窗口內檢測到舉手（雙手腕高於肩膀關鍵點），兩個動作依序完成即觸發骰子擲取
- **FR-005**: 系統必須維護一個任務庫，包含至少 10 種不同的健身動作類型（深蹲、伏地挺身、開合跳、弓箭步、平板支撐、仰臥起坐、波比跳、登山跑、高抬腿、俄羅斯轉體）
- **FR-006**: 系統必須能夠隨機抽取任務，並為每個任務隨機分配合理的次數（範圍：5-20 次）和組數（範圍：1-3 組）
- **FR-007**: 系統必須在「任務執行中」狀態下，根據當前任務類型定義的骨架關鍵點規則驗證動作是否正確執行
- **FR-008**: 系統必須為每種健身動作定義驗證規則（例如：深蹲 = 髖關節高度低於膝關節、伏地挺身 = 手肘彎曲角度 < 90 度且鼻子接近地面），並使用寬鬆容忍度模式：角度誤差 ±15-20 度、距離比例誤差 ±10%，以提供友好的遊戲體驗
- **FR-009**: 系統必須實時追蹤並顯示當前任務的完成進度：當前組的已完成次數、總次數、當前組數、總組數
- **FR-010**: 系統必須使用 PyGame 實作圖形介面，採用左右分割布局：左側攝像頭畫面區域（占 70% 寬度）顯示即時畫面並疊加骨架標記，右側資訊面板（占 30% 寬度）垂直排列顯示當前任務文字描述、進度條或數字顯示、當前遊戲狀態提示、FPS 計數器和推理時間
- **FR-011**: 系統必須在攝像頭畫面上即時渲染 YOLOv8-Pose 偵測到的骨架關鍵點（至少 17 個 COCO 關鍵點）和連線
- **FR-012**: 系統必須在完成所有組數和次數後，顯示完成訊息（例如「任務完成！你已不再是弱雞！」）持續 3-5 秒，然後自動返回「等待開始」狀態
- **FR-013**: 系統必須在 PyGame 介面上顯示即時的 FPS 計數器和推理時間（用於性能監控）
- **FR-014**: 系統必須處理攝像頭異常情況（無法連接、FPS 過低、畫面中斷），並顯示適當的錯誤訊息
- **FR-015**: 系統必須在偵測到多個人體骨架時，選擇並追蹤單一目標（選擇策略：畫面中心最近或置信度最高的骨架）

### Key Entities

- **遊戲狀態 (GameState)**: 表示當前遊戲所處的階段，包含五種狀態值（WAITING、DICE_ROLL_DETECTING、TASK_DISPLAY、TASK_EXECUTING、COMPLETION），以及狀態轉換的觸發條件和時間戳
- **健身任務 (WorkoutTask)**: 表示一次健身挑戰，包含動作類型（例如「深蹲」）、每組次數（例如 15）、總組數（例如 2）、任務描述文字、驗證規則引用
- **任務庫 (TaskLibrary)**: 包含所有可用的健身動作定義，每個動作包含名稱、驗證規則（關鍵點條件）、難度等級（可選）、次數範圍、組數範圍
- **動作驗證器 (ActionValidator)**: 根據當前任務的動作類型，接收骨架關鍵點數據並判斷動作是否正確執行，輸出布林值和可選的錯誤提示
- **進度追蹤器 (ProgressTracker)**: 維護當前任務的執行狀態，包含當前組數、當前組已完成次數、是否完成所有組、最後一次有效動作的時間戳
- **骨架數據 (PoseData)**: 從 YOLOv8-Pose 輸出的單幀人體姿態數據，包含 17 個關鍵點的 (x, y, confidence) 座標、邊界框、整體置信度
- **攝像頭管理器 (CameraManager)**: 負責攝像頭初始化、幀捕獲、FPS 控制、異常偵測（斷線、低 FPS）、資源釋放

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 玩家可以在 5 秒內完成從「等待開始」到成功擲骰子並看到任務的流程（包含執行跳躍+舉手動作的時間）
- **SC-002**: 系統在 Jetson Orin Nano 上運行時，攝像頭捕獲和姿態偵測的整體幀率穩定維持在 20 FPS 以上
- **SC-003**: YOLOv8-Pose 模型的推理延遲在 TensorRT 加速下低於 50ms（單幀，640x640 輸入）
- **SC-004**: 動作驗證的準確率達到 90% 以上（正確執行的動作應被識別，錯誤或不完整的動作應被拒絕）
- **SC-005**: 玩家可以連續完成 3 次任務循環（擲骰子 → 執行任務 → 完成驗證 → 再次擲骰子）而無系統崩潰或性能明顯下降
- **SC-006**: PyGame 介面的渲染開銷低於 5ms 每幀，不影響整體 FPS 目標
- **SC-007**: 系統從啟動到進入「等待開始」狀態的初始化時間低於 10 秒（包含 TensorRT 引擎加載）
- **SC-008**: 在正常光線條件下（室內日光燈或自然光），YOLOv8-Pose 的骨架偵測成功率達到 95% 以上
- **SC-009**: 玩家完成一個完整任務（例如深蹲 15 次 x 2 組）所需的時間在合理範圍內（2-5 分鐘，取決於動作難度和玩家體能）
- **SC-010**: 系統記憶體佔用低於 4GB，GPU 記憶體佔用低於 6GB（滿足 Jetson Orin Nano 8GB 變體的限制）

## Assumptions

- **硬體環境**: 假設運行在 NVIDIA Jetson Orin Nano（6GB 或 8GB 變體）上，已安裝 JetPack 5.x、CUDA 11.4+、TensorRT 8.5+
- **攝像頭**: 假設使用 CSI 攝像頭或 USB 攝像頭，解析度至少 720p，支援 GStreamer 或 V4L2 驅動
- **光線條件**: 假設在室內正常光線條件下使用（非完全黑暗或強逆光環境）
- **單人遊戲**: 假設主要使用場景為單人遊戲，多人入鏡視為邊緣情況
- **Python 版本**: 假設使用 Python 3.8-3.10（JetPack 相容範圍）
- **YOLOv8-Pose 模型**: 使用 YOLOv8n-pose (nano 變體，~3M 參數)，已轉換為 TensorRT FP16 引擎，目標推理性能 30-40 FPS
- **動作定義**: 假設健身動作的驗證規則基於簡化的生物力學原理（例如關節角度、相對位置），不要求專業級精確度
- **網路連線**: 假設系統完全離線運行，無需網路連線（模型和資源在設置階段已下載）
- **存儲空間**: 假設有足夠的存儲空間用於 TensorRT 引擎檔案（約 50-100 MB）和任務配置檔案
- **遊戲時長**: 假設單次遊戲時長為 5-30 分鐘，系統無需處理超長時間運行的資源洩漏問題（但應正確清理 GPU 資源）

## Dependencies

- **外部**: 無（所有推理在設備端執行，無雲端 API 依賴）
- **內部**: 需要預先設置 TensorRT 環境、轉換 YOLOv8-Pose 模型、配置攝像頭驅動
- **資料**: 需要任務庫配置檔案（JSON 格式，定義 10+ 種健身動作及其驗證規則），使用 Python 標準庫 json 模組載入

## Out of Scope

- **多人對戰模式**: 目前僅支援單人遊戲，多人模式未包含在此功能中
- **遊戲進度存儲**: 不保存歷史任務完成記錄、統計數據或玩家成就系統
- **語音提示**: 不包含語音指導或語音回饋功能
- **自訂任務**: 玩家無法自行創建或編輯任務，僅使用預設任務庫
- **難度調整**: 系統不會根據玩家表現動態調整任務難度
- **網路排行榜**: 無線上排行榜或社交分享功能
- **動作教學**: 不提供動作示範視頻或詳細的動作指導介面
- **觸控輸入**: 僅支援基於姿態的互動，不包含鍵盤/滑鼠控制（除了開發調試用途）
- **跨平台**: 僅針對 Jetson Orin Nano 優化，不保證在其他平台（PC、樹莓派等）上的性能
